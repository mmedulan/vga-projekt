<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Reflex Challenge VR</title>
  <meta name="description" content="Simple VR Reflex Training Game">
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@6.1.1/dist/aframe-extras.misc.min.js"></script>
  <script src="https://unpkg.com/super-hands@^3.0.3/dist/super-hands.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@6.1.1/dist/aframe-extras.controls.min.js"></script>
  <style>
    .a-text {
      font-family: Arial, Helvetica, sans-serif;
      font-size: 1.5em;
      color: black;
    }
  </style>
</head>
<body>
<a-scene inspector>
  <a-entity id="cameraRig" movement-limiter="xmin: -5; xmax: 5; zmin: -5; zmax: 5">
    <a-camera></a-camera>

    <!-- VR ruce s super-hands komponentou a sphere-collider -->
    <a-entity id="leftHand" hand-controls="hand: left; handModelStyle: lowPoly; color: #FF0000"
              super-hands="colliderEvent: hit; colliderEndEvent: hitend"
              sphere-collider="objects: .clickable"
              color="#FFFFFF"></a-entity>
    <a-entity id="rightHand" hand-controls="hand: right; handModelStyle: lowPoly; color: #FF0000"
              super-hands="colliderEvent: hit; colliderEndEvent: hitend"
              sphere-collider="objects: .clickable"
              color="#FFFFFF"></a-entity>
    <a-entity oculus-touch-controls="hand: left"></a-entity>
    <a-entity oculus-touch-controls="hand: right"></a-entity>
    <a-entity id="backgroundMusic" sound="src: #background-music; autoplay: true; loop: true; volume: 0.1"></a-entity>
  </a-entity>






  <a-assets>
    <audio id="bad-hit-sound" src="assets/bad_hit.wav" preload="auto"></audio>
    <audio id="hit-sound" src="assets/hit.mp3" preload="auto"></audio>
    <audio id="background-music" src="assets/ambient.mp3" preload="auto"></audio>


    <img id="heart" src="assets/green_heart.png" />
    <img id="groundTexture" src="assets/ground.jpg" />

    <img id="night_sky" src="assets/night_sky.jpg">

    <a-asset-item id="gltf-ground" src="assets/gray_rocks/gray_rocks_4k.gltf"></a-asset-item>

  </a-assets>



  <!-- Kamera s kurzorem a raycasterem
  <a-entity camera look-controls wasd-controls position="0 1.6 0">
    <a-entity cursor="rayOrigin: mouse"
              raycaster="objects: .clickable"
              position="0 0 -1"
              geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
              material="color: transparent; opacity: 0"
              visible="false">
    </a-entity>
  </a-entity>
-->


  <!-- Pozadí -->
  <a-sky src="#night_sky" rotation="0 -900 0" position="0 400 0"></a-sky> <!-- Modré nebe -->



  <!-- Podlaha s texturou -->
  <a-plane src="#groundTexture" position="0 0 0" rotation="-90 0 0" width="10" height="10" shadow="receive: ture"></a-plane>

  <!-- Vzhled koulí-->
  <a-mixin id="futuristic-ball"
           material="shader: standard; metalness: 0.8; roughness: 0; emissive: green; emissiveIntensity: 5; specular: #FFF"
           shadow="cast: true"
           light="type: point; color: green; intensity: 2; distance: 5; decay: 2;"
            explode="pieces: 10; radius: 0.01; color: red"
  >
  </a-mixin>


  <!-- Vytvoření 9 míčků před hráčem -->
  <a-entity id="balls">


    <a-sphere class="clickable ball" position="-0.25 1.5 -0.35" radius="0.05" mixin="futuristic-ball"></a-sphere>
    <a-sphere class="clickable ball" position="0 1.5 -0.35" radius="0.05" mixin="futuristic-ball"></a-sphere>
    <a-sphere class="clickable ball" position="0.25 1.5 -0.35" radius="0.05" mixin="futuristic-ball"></a-sphere>
    <a-sphere class="clickable ball" position="-0.25 1.25 -0.35" radius="0.05" mixin="futuristic-ball"></a-sphere>
    <a-sphere class="clickable ball" position="0 1.25 -0.35" radius="0.05" mixin="futuristic-ball"></a-sphere>
    <a-sphere class="clickable ball" position="0.25 1.25 -0.35" radius="0.05" mixin="futuristic-ball"></a-sphere>
    <a-sphere class="clickable ball" position="-0.25 1 -0.35" radius="0.05" mixin="futuristic-ball"></a-sphere>
    <a-sphere class="clickable ball" position="0 1 -0.35" radius="0.05" mixin="futuristic-ball"></a-sphere>
    <a-sphere class="clickable ball" position="0.25 1 -0.35" radius="0.05" mixin="futuristic-ball"></a-sphere>


  <!--Sloupce navíc: Levý sloupec míčků

  <a-sphere class="clickable ball" position="-0.5 1.5 -0.35" radius="0.05" mixin="futuristic-ball"></a-sphere>

  <a-sphere class="clickable ball" position="-0.5 1.25 -0.35" radius="0.05" mixin="futuristic-ball"></a-sphere>

  <a-sphere class="clickable ball" position="-0.5 1 -0.35" radius="0.05" mixin="futuristic-ball"></a-sphere>
  -->

  <!-- Pravý sloupec míčků
  <a-sphere class="clickable ball" position="0.5 1.5 -0.35" radius="0.05" mixin="futuristic-ball"></a-sphere>

  <a-sphere class="clickable ball" position="0.5 1.25 -0.35" radius="0.05" mixin="futuristic-ball"></a-sphere>

  <a-sphere class="clickable ball" position="0.5 1 -0.35" radius="0.05" mixin="futuristic-ball"></a-sphere>
    -->
  </a-entity>



  <!-- Srdce -->
  <a-entity id="hearts" position="-2 3 -3">
    <a-image src="#heart" position="0 0 0" width="0.3" height="0.3"></a-image>
    <a-image src="#heart" position="0.4 0 0" width="0.3" height="0.3"></a-image>
    <a-image src="#heart" position="0.8 0 0" width="0.3" height="0.3"></a-image>
    <a-image src="#heart" position="1.2 0 0" width="0.3" height="0.3"></a-image>
    <a-image src="#heart" position="1.6 0 0" width="0.3" height="0.3"></a-image>
    <a-image src="#heart" position="2 0 0" width="0.3" height="0.3"></a-image>
    <a-image src="#heart" position="2.4 0 0" width="0.3" height="0.3"></a-image>
    <a-image src="#heart" position="2.8 0 0" width="0.3" height="0.3"></a-image>
    <a-image src="#heart" position="3.2 0 0" width="0.3" height="0.3"></a-image>
    <a-image src="#heart" position="3.6 0 0" width="0.3" height="0.3"></a-image>
  </a-entity>

  <!-- Skóre zobrazené nad míčky -->
  <a-entity id="scoreboard" position="0 2 -3" text="value: Score: 0; color: white; align: center; width: 3;"></a-entity>

  <!-- Game Over text (skrytý) -->
  <a-entity id="gameOver" position="0 2 -3" text="value: GAME OVER; color: red; align: center; width: 6;" visible="false"></a-entity>
  <a-entity id="finalScore" position="0 1.5 -3" text="value: ; color: white; align: center; width: 6;" visible="false"></a-entity>

  <!-- Tlačítko RESTART -->
  <a-entity id="restartButton" position="0 1 -3" geometry="primitive: plane; height: 0.2; width: 0.2" text="value: FOR RESTART PRESS A; align: center; color: white; width: 6"
            class="" visible="false"></a-entity>

  <!-- Zvukové entity -->
  <a-entity id="correctHitSound" sound="src: #hit-sound; volume: 0.1"></a-entity>
  <a-entity id="incorrectHitSound" sound="src: #bad-hit-sound; volume: 0.5"></a-entity>

  <script>
    let lives = 10;

    // Funkce pro přidání bodu při zásahu míčku
    function addScore(ball) {
      if (ball.hasAttribute('processed')) return;
      ball.setAttribute('processed', true);

      if (ball.getAttribute('material').color === 'red') {
        var hitSoundEntity = document.querySelector('#correctHitSound');
        hitSoundEntity.components.sound.playSound();

        var scoreboard = document.querySelector('#scoreboard');
        var score = parseInt(scoreboard.getAttribute('text').value.split(': ')[1]) + 1;
        scoreboard.setAttribute('text', 'value', 'Score: ' + score);

        ball.emit('hit'); // Spustí explozi
      } else if (ball.getAttribute('material').color === 'green') {
        var badHitSoundEntity = document.querySelector('#incorrectHitSound');
        badHitSoundEntity.components.sound.playSound();

        lives--;
        if (lives >= 0) {
          let hearts = document.querySelectorAll('#hearts a-image');
          hearts[lives].setAttribute('visible', 'false');
        }
        if (lives === 0) {
          gameOver();
        }
      }
      setTimeout(() => ball.removeAttribute('processed'), 500);
    }

    // Funkce pro náhodné blikání míčku
    function flashRandomBall() {
      var balls = document.querySelectorAll('.ball');
      var randomIndex = Math.floor(Math.random() * balls.length);
      var randomBall = balls[randomIndex];

      // Změna barvy míčku na červenou
      randomBall.setAttribute('material', {
        shader: 'standard',
        metalness: 0.8,
        roughness: 0,
        color: 'red',
        emissive: 'red',
        emissiveIntensity: 5,
        specular: '#FFF'
      });
      randomBall.setAttribute('shadow', 'cast', true);
      randomBall.setAttribute('light', {
        type: 'point',
        color: 'red',
        intensity: 2,
        distance: 5,
        decay: 2
      });

      // Po krátké chvíli (700ms) vrátíme barvu zpět na zelenou
      setTimeout(function () {
        randomBall.setAttribute('material', {
          shader: 'standard',
          metalness: 0.8,
          roughness: 0,
          color: 'green',
          emissive: 'green',
          emissiveIntensity: 5,
          specular: '#FFF'
        });
        randomBall.setAttribute('light', {
          type: 'point',
          color: 'green',
          intensity: 2,
          distance: 5,
          decay: 2
        });
      }, 700);
    }

    // Přidání událostí pro každý míček
    document.querySelectorAll('.ball').forEach(function(ball) {
      console.log('Adding click and grab-start events to ball');  // Debugovací zpráva
      ball.addEventListener('click', function() { addScore(ball); });
      ball.addEventListener('grab-start', function() { addScore(ball); });
    });

    // Přidání kolizních detektorů k rukám
    document.querySelectorAll('[hand-controls]').forEach(function(hand) {
      hand.addEventListener('hit', function(evt) {
        var hitEl = evt.detail.el;
        if (hitEl && hitEl.classList.contains('ball')) {
          hitEl.emit('click');  // Spustí událost kliknutí na míček
        }
      });
    });

    // Přidání události pro restartovací tlačítko
    document.querySelector('#restartButton').addEventListener('click', function() {
      restartGame();
    });

    // Funkce pro zobrazení Game Over
    function gameOver() {
      // Skrytí všech objektů ve scéně kromě hlášky Game Over, skóre a tlačítka RESTART
      document.querySelector('#balls').setAttribute('visible', 'false');
      document.querySelector('#hearts').setAttribute('visible', 'false');
      document.querySelector('#scoreboard').setAttribute('visible', 'false');
      document.querySelector('#leftHand').setAttribute('visible', 'false');
      document.querySelector('#rightHand').setAttribute('visible', 'false');

      // Zobrazení Game Over textu, skóre a tlačítka RESTART
      var score = document.querySelector('#scoreboard').getAttribute('text').value.split(': ')[1];
      document.querySelector('#gameOver').setAttribute('visible', 'true');
      document.querySelector('#finalScore').setAttribute('text', 'value', 'YOUR SCORE: ' + score);
      document.querySelector('#finalScore').setAttribute('visible', 'true');
      document.querySelector('#restartButton').setAttribute('visible', 'true');

      // Přidání detekce stisku tlačítka A na ovladači Meta Quest
      document.querySelector('a-scene').addEventListener('buttondown', function(evt) {
        if (evt.detail.id === 1) { // id 1 odpovídá tlačítku A na Meta Quest ovladači
          restartGame();
        }
      });
    }

    // Funkce pro restart hry
    function restartGame() {
      // Resetování herních proměnných a stavu
      lives = 10;
      document.querySelector('#scoreboard').setAttribute('text', 'value', 'Score: 0');

      // Znovu zobrazení všech objektů ve scéně
      document.querySelector('#balls').setAttribute('visible', 'true');
      document.querySelector('#hearts').setAttribute('visible', 'true');
      document.querySelector('#scoreboard').setAttribute('visible', 'true');
      document.querySelector('#leftHand').setAttribute('visible', 'true');
      document.querySelector('#rightHand').setAttribute('visible', 'true');

      // Skrytí Game Over textu, skóre a tlačítka RESTART
      document.querySelector('#gameOver').setAttribute('visible', 'false');
      document.querySelector('#finalScore').setAttribute('visible', 'false');
      document.querySelector('#restartButton').setAttribute('visible', 'false');

      // Resetování srdcí
      document.querySelectorAll('#hearts a-image').forEach(function(heart) {
        heart.setAttribute('visible', 'true');
      });
    }

    // Spuštění blikání míčků v náhodných intervalech 1-3 sekundy
    function startFlashing() {
      flashRandomBall();
      var randomInterval = Math.floor(Math.random() * 2000) + 1000;
      setTimeout(startFlashing, randomInterval);
    }

    startFlashing(); // Zahájení blikání


    //Ovládání:
    AFRAME.registerComponent('oculus-thumbstick-controls', {
      schema: {
        acceleration: { default: 45 },
        rigSelector: { default: "#cameraRig" },
        fly: { default: false },
        controllerOriented: { default: false },
        adAxis: { default: 'x' },
        wsAxis: { default: 'z' },
        enabled: { default: true },
        adEnabled: { default: true },
        adInverted: { default: false },
        wsEnabled: { default: true },
        wsInverted: { default: false }
      },
      init: function () {
        this.easing = 1.1;
        this.velocity = new THREE.Vector3(0, 0, 0);
        this.tsData = new THREE.Vector2(0, 0);
        this.el.addEventListener('axismove', this.onAxisMove.bind(this));
      },
      onAxisMove: function (event) {
        const axis = event.detail.axis;
        const cameraRig = document.querySelector(this.data.rigSelector);

        if (event.target.components['oculus-touch-controls'].data.hand === 'left') {
          cameraRig.object3D.position.x += axis[2] * 0.05; // Horizontal movement
          cameraRig.object3D.position.z += axis[3] * 0.05; // Forward/Backward movement
        }

        if (event.target.components['oculus-touch-controls'].data.hand === 'right') {
          cameraRig.object3D.rotation.y -= axis[2] * 0.05; // Yaw rotation
        }
      }
    });

    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('[oculus-touch-controls]').forEach(el => {
        el.setAttribute('oculus-thumbstick-controls', '');
      });
    });




    document.querySelector('[oculus-touch-controls="hand: left"]').addEventListener('abuttondown', function(evt) {
      restartGame();
    });
    document.querySelector('[oculus-touch-controls="hand: right"]').addEventListener('abuttondown', function(evt) {
      restartGame();
    });

    /*
    AFRAME.registerComponent('explode', {
      schema: {
        pieces: {type: 'int', default: 10},
        radius: {type: 'number', default: 0.05},
        color: {type: 'color', default: '#FF0000'}
      },

      init: function() {
        this.el.addEventListener('hit', () => this.explode());
      },

      explode: function() {
        let position = this.el.getAttribute('position');
        let sceneEl = this.el.sceneEl;

        for (let i = 0; i < this.data.pieces; i++) {
          let piece = document.createElement('a-sphere');
          piece.setAttribute('radius', this.data.radius);
          piece.setAttribute('color', this.data.color);
          piece.setAttribute('position', `${position.x} ${position.y} ${position.z}`);
          piece.setAttribute('velocity', {
            x: (Math.random() - 0.5) * 2,
            y: (Math.random() - 0.5) * 2,
            z: (Math.random() - 0.5) * 2
          });
          sceneEl.appendChild(piece);
        }

        this.el.parentNode.removeChild(this.el); // Odstraní původní kouli
      }
    });
  */

    function getRandomNumber(min, max) {
      return Math.random() * (max - min) + min;
    }

    function setNewRandomPosition(ball) {
      let balls = document.querySelectorAll('.ball');
      let position;
      let newPosition;
      let isColliding;

      do {
        position = ball.getAttribute('position');
        newPosition = {
          x: position.x + getRandomNumber(-0.1, 0.1),
          y: position.y + getRandomNumber(-0.1, 0.1),
          z: position.z
        };

        isColliding = false;

        balls.forEach(otherBall => {
          if (otherBall !== ball) {
            let otherPosition = otherBall.getAttribute('position');
            let distance = Math.sqrt(
                    Math.pow(newPosition.x - otherPosition.x, 2) +
                    Math.pow(newPosition.y - otherPosition.y, 2)
            );

            if (distance < 0.1) { // Adjust this value based on the radius of the spheres
              isColliding = true;
            }
          }
        });
      } while (isColliding);

      ball.setAttribute('animation__position', {
        property: 'position',
        to: `${newPosition.x} ${newPosition.y} ${newPosition.z}`,
        dur: getRandomNumber(3000, 5000), // Duration between 3 and 5 seconds
        easing: 'easeInOutSine',
        loop: false
      });
    }

    // Add smooth random movement animations to each ball
    document.querySelectorAll('.ball').forEach(function(ball) {
      setInterval(function() {
        setNewRandomPosition(ball);
      }, getRandomNumber(1000, 2000));
    });// Interval between 1 and 2 seconds

    //Limiter pohybu
    AFRAME.registerComponent('movement-limiter', {
      schema: {
        xmin: {type: 'number', default: -5},
        xmax: {type: 'number', default: 5},
        zmin: {type: 'number', default: -5},
        zmax: {type: 'number', default: 5}
      },
      tick: function () {
        var position = this.el.getAttribute('position');
        if (position.x < this.data.xmin) position.x = this.data.xmin;
        if (position.x > this.data.xmax) position.x = this.data.xmax;
        if (position.z < this.data.zmin) position.z = this.data.zmin;
        if (position.z > this.data.zmax) position.z = this.data.zmax;
        this.el.setAttribute('position', position);
      }
    });


  </script>
</a-scene>
</body>
</html>
